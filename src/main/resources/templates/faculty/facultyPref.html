<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<th:block th:include="fragments/fac_header.html :: headerfiles"></th:block>
	
	<link rel="stylesheet" th:href="@{/css/faculty/fac_pref.css}">
	<link rel="stylesheet" th:href="@{/css/register.css}">
	<script th:src="@{/webjars/jquery/3.2.1/jquery.min.js}"></script>
	<title>Faculty Preferences</title>

	<script>
		var setChoice;
		var clearChoice;
		var inputChoice;
		var prefData = [];
		var SE=0, TE=0, BE=0;
		$(document).ready(function(){
		    $(".choose").click(function(){
		        setChoice = this.id;
		        
		        var ind = setChoice[setChoice.length-1];
		        if(prefData[ind])
		        {
		        	alert("You first need to clear the selected choice");
		        	return;
		        }
		        $("#form1").show();
		        $("#form2").hide();
		        $("#heading").hide();
		    });  
		});
		
		$(document).ready(function(){
		    $(".clear").click(function(){
		    	clearChoice = this.id;
		        $('#'+clearChoice).html("");
		        
		        var ind = clearChoice[clearChoice.length-1];
		        if(prefData[ind].year=="BE")
		        	BE--;
		        if(prefData[ind].year=="TE")
		        	TE--;
		        if(prefData[ind].year=="SE")
		        	SE--;
		        
		        prefData[ind]=null;
		        
		        $("#form1").hide();
		        $("#form2").hide();
		        $('#messageDiv').hide();
		    });  
		});
		
		
		$(document).ready(function(){
			$('#form1').submit(function() {
				return false;
			});
		});
		
		$(document).ready(function(){
			$('#form2').submit(function() {
				return false;
			});
		});
		
		</script>

</head>

<div th:replace="fragments/fac_header :: header"></div>

<!-- script to turn nav link active -->
<script type="text/javascript">
	var navBar = document.getElementById("nav-bar");
	var current = navBar.getElementsByClassName("active");
    // If there's any other active nav, make it inactive
    if (current.length > 0) { 
      current[0].className = current[0].className.replace(" active", "");
    }
	//set current page nav as active
	document.getElementById("cpref-nav").className+=" active";		
</script>


<body>



<div class="sidebar">
  
  <table>
  	<tr>
  		<td colspan=4 align=center>
  			<h5>Give Preferences</h5>
  		</td>
  	</tr>
  	
  	<tr>
  		<td>
  			<h6>1</h6>
  		</td>
  		<td style="width:250px">
  			<h6 id="pref1"></h6>
  		</td>
  		<td>
			<button class="choose" id="pref1">Choose</button>			
  		</td>
  		<td>
			<button class="clear" id="pref1">Clear</button>			
  		</td>
  	</tr>
  	
  	<tr>
  		<td>
  			<h6>2</h6>
  		</td>
  		<td>
  			<h6 id="pref2"></h6>
  		</td>
  		<td>
  			<button class="choose" id="pref2">Choose</button>	
  		</td>
  		<td>
			<button class="clear" id="pref2">Clear</button>			
  		</td>
  	</tr>
  	
  	<tr>
  		<td>
  			<h6>3</h6>
  		</td>
  		<td>
  			<h6 id="pref3"></h6>
  		</td>
  		<td>
  			<button class="choose" id="pref3">Choose</button>	
  		</td>
  		<td>
			<button class="clear" id="pref3">Clear</button>			
  		</td>
  	</tr>
  	
  	<tr>
  		<td>
  			<h6>4</h6>
  		</td>
  		<td>
  			<h6 id="pref4"></h6>
  		</td>
  		<td>
  			<button class="choose" id="pref4">Choose</button>	
  		</td>
  		<td>
			<button class="clear" id="pref4">Clear</button>			
  		</td>
  	</tr>
  	
  	<tr>
  		<td>
  			<h6>5</h6>
  		</td>
  		<td>
  			<h6 id="pref5"></h6>
  		</td>
  		<td>
  			<button class="choose" id="pref5">Choose</button>	
  		</td>
  		<td>
			<button class="clear" id="pref5">Clear</button>			
  		</td>
  	</tr>
  	
  	<tr>
  		<td>
  			<h6>6</h6>
  		</td>
  		<td>
  			<h6 id="pref6"></h6>
  		</td>
  		<td>
  			<button class="choose" id="pref6">Choose</button>	
  		</td>
  		<td>
			<button class="clear" id="pref6">Clear</button>			
  		</td>
  	</tr>
  	
  	<tr>
		<td colspan=4 align=center>
       		<button type="submit" id="submit" class="btn btn-primary btn-block" onclick="submitPrefs()"  style="width:150px; background-color: #2B7526;">Submit</button>
    	</td> 	  
	</tr>
  </table>
 
  
</div>



<div class="content"  >
  <div class="card bg-light">
  <article class="card-body mx-auto">
  	<h4 id="heading">Press the choose button to select preferences</h4>
	<form role="form" id="form1">
	<h4 class="card-title mt-3 text-center">Select Course Year</h4>
	<table>
		<tr>
			<td>
			    Select Year
			</td>
			<td>
				<select class="form-control" th:name="year" th:id="year" required>
					<option th:value="none" style="color:#8F8B87" selected >Select Year</option>
					<option value="SE" style="color:#000">SE</option>
					<option value="TE" style="color:#000">TE</option>
					<option value="BE" style="color:#000">BE</option>
				</select>	
			</td>
		</tr>
		
		<tr>
			<td colspan=2 align=center>
				<div class="form-group">
		        	<button id="getChoices" class="btn btn-primary btn-block" style="width:150px"> Get Choices  </button>
		    	</div> <!-- form-group// -->  
			</td>
		</tr>
	</table>
	</form>
</article>	


<div th:id="messageDiv">
<div class="row text-center card-body mx-auto" th:fragment="messageDiv">
	<div class="alert alert-success" role="alert" th:if="${msg}" th:utext="${msg}"></div>
	<div class="alert alert-danger" role="alert"  id="err" th:if="${err_msg}" th:utext="${err_msg}"></div>
	
	<script>
		if ($('#err').length) {
	 	   $('.sidebar').hide();
	 	   $('#form2').hide();
	 	   $('#messageDiv').show();   
		}
	</script>
	
</div>
</div>


<article class="card-body mx-auto" id="article2">
    <form role="form" id="form2" th:fragment="selectPreferenceFragment"> 
    <h4 class="card-title mt-3 text-center card-body mx-auto">Give preferences for <span th:text="${chosen_year_name}"></span> courses</h4>
    <div th:id="selectPreferenceFragment">
    <table>
    	<tr>
    		<td>
    			Select Course
    		</td>
    		<td>
    			<select class="form-control" th:name="chosenCourse" id="selectPref">
					<option th:value="none" style="color:#8F8B87" selected>Select Course</option>
					<option th:each="i : ${resultSet}" th:text="${i.elective!=null ? i.elective.electiveName +'('+i.elective.electiveCourseId +')' : i.course.courseName +'('+i.course.courseId +')'}" 
					th:value="${i.elective!=null ? i.elective.electiveCourseId : i.course.courseId}" 
					th:attr="data-pr1=${i.preReq1},data-pr2=${i.preReq2}" style="color:#000">
					</option>
				</select>
    		</td>
    	</tr>
    	<!--  ${i.elective!=null ? i.elective.electiveCourseId : i.course.courseId}-->
    	<tr class="exp" style="display: none">
    		<td>
    			Number of times course taught
    		</td>
    		<td>
				<input id="courseExp"  name="courseExp" class="form-control" placeholder="Course Experience (in yrs)" type="number" min="0" required autofocus/>
    		</td>
    	</tr>
    	<tr class="exp" style="display: none">
    		<td colspan=2><h5 class="card-title mt-3 text-center card-body mx-auto">Prerequisite experience</h5></td>
    	</tr>
    	<tr class="exp" style="display: none">
    		<td id = "prereq1">
    			
    		</td>
    		<td>
    			<input id="prereq1Exp"  name="prereq1Exp" class="form-control" placeholder="Prerequisite 1 experience (in yrs)" type="number" min="0" required autofocus/>
    		</td>
    	</tr>
    	
    	<tr class="exp" style="display: none">
    		<td id ="prereq2">
    			
    		</td>
    		<td>
    			<input id="prereq2Exp"  name="prereq2Exp" class="form-control" placeholder="Prerequisite 2 experience (in yrs)" type="number" min="0" required autofocus/>
    		</td>
    	</tr>
    	
    	<tr class="exp" style="display: none">
			<td colspan=2 align=center>
				<div class="form-group">
		        	<button id="givePref" class="btn btn-primary btn-block" onclick="givePrefs()" style="width:165px"> Select Preference  </button>
		    	</div> <!-- form-group// -->  
			</td>
		</tr>
    </table>
    </div>
	</form>
</article>

<div class="row text-center mx-auto">
	<div class="alert alert-success" role="alert" th:if="${msg1}" th:utext="${msg1}"></div>
</div>  
</div>
</div>

<script>
	$('#getChoices').click(function(){
		var cyear = $('#year').val();
        if (cyear == "none") {
            alert("Please select a course year");
            $('#year').focus();
            
           return false;
        } 
		console.log('ajax: '+$('#year').val());
		
		if(cyear=="BE")
		{
			if(BE>=2)
			{
				alert("Maximum preference for selected year reached. Cannot give more than 2 preferences for a single year");
				return;
			}
		}
		if(cyear=="TE")
		{
			if(TE>=2)
			{
				alert("Maximum preference for selected year reached. Cannot give more than 2 preferences for a single year");
				return;
			}
		}
		if(cyear=="SE")
		{
			if(SE>=2)
			{
				alert("Maximum preference for selected year reached. Cannot give more than 2 preferences for a single year");
				return;
			}
		}
		
		$.ajax({
	        type: "GET",
	        contentType: "application/json",
	        url: '/u/faculty/getFacPrefForm',
	        data: {year: $('#year').val() },
	        success: function (response) {
              	if ($(response).find('#err').length) {
             	   $('#messageDiv').html('');
             	   $('#messageDiv').html(response); 
             	   $('#form2').hide();
             	   $('#form2').html('');
             	   $('#messageDiv').show();
             	   
                }
                else{
	              	$('#form2').html('');
	              	$('#form2').html(response);
	              	$('#form2').show();
	             	$('#messageDiv').hide();                   

                }
              }
		});
	});
	
	function givePrefs()
	{
		var cexp = $('#courseExp');
		var prereq1exp = $('#prereq1Exp');
		var prereq2exp = $('#prereq2Exp');
        if (cexp.val() == "none" || prereq1exp.val() == "" || prereq2exp.val() == "") {
            alert("Please enter all the fields");
          
           return false;
        } 
		
        var cyear = $('#year').val(); 
        if(cyear=="BE")
			BE++;
		if(cyear=="TE")
			TE++;
		if(cyear=="SE")
			SE++;
		
		console.log(BE);
        
       	$('#form1').hide();
       	$('#form2').hide();
       	$('#'+setChoice).html($('#selectPref').val());
       	var cId = $('#selectPref').val();
       	var cExp = $('#courseExp').val();
       	var pr1Exp = $('#prereq1Exp').val();
       	var pr2Exp = $('#prereq2Exp').val();
       	var year = $('#year').val();
       	
       	var ind = setChoice[setChoice.length-1];
       	prefData[ind]={
       		"prefNo":ind,
       		"courseId":cId,
       		"courseExp":cExp,
       		"prereq1Exp":pr1Exp,
       		"prereq2Exp":pr2Exp,       		
       		"year":year									       	
       	};
       	
       	
       	
       	console.log(prefData);
       	
      	$('#messageDiv').hide();
      	$("#heading").show();

	}
	
	function submitPrefs()
	{
		console.log(prefData);
		var facultyPrefs = [];
		
		for(var i in prefData) {
			facultyPrefs.push(prefData[i]);
		}
		
		console.log(facultyPrefs);
		
		facultyPrefs = JSON.stringify({
			'facultyPrefs': facultyPrefs
		});
		
		$.ajax({
	        type: "POST",
	        contentType: "application/json",
	        url: '/u/faculty/setFacPrefs',
	        data: facultyPrefs,
	        dataType: 'html',
	        mimeType: 'application/json',
	        success: function (response) {
	        	alert("Preferences set successfully")
	        }
    
		});
	}
	</script>
	
	<script>
	//$('#selectPref').change(function () 
	$('#article2').on("change","select",function(){
		if($(this).val()=='none'){
			$('.exp').hide();
		}
		else{
			$('.exp').show();
			console.log($(this).find(':selected').attr('data-pr1'));
			var prereq1 = $(this).find(':selected').attr('data-pr1');
			var prereq2 = $(this).find(':selected').attr('data-pr2');
			$('#prereq1').text(prereq1);
			$('#prereq2').text(prereq2);
		}
		
	});
	</script>
</body>
</html>
